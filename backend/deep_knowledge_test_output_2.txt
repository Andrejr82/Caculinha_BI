INFO:app.services.chat_service_v3:Inicializando ChatServiceV3 (Metrics-First)...
INFO:app.core.llm_factory:SmartLLM initialized: primary=google, gemini_available=True
INFO:app.services.metrics_calculator:MetricsCalculator inicializado com parquet: C:\Agente_BI\BI_Solution\data\parquet\admmat.parquet
INFO:app.services.chat_service_v3:\u2705 ChatServiceV3 inicializado com sucesso
INFO:app.services.chat_service_v3:[V3] Processando query: 'Quais colunas vocÛ tem acesso no banco de dados?...'
INFO:app.services.query_interpreter:Interpretando query: 'Quais colunas vocÛ tem acesso no banco de dados?...'
INFO:app.services.query_interpreter:HeurÝstica falhou ou baixa confianþa. Usando LLM fallback...
INFO:app.core.llm_gemini_adapter:Gemini adapter inicializado com modelo: gemini-2.5-flash-lite
INFO:app.core.llm_groq_adapter:[OK] GroqLLMAdapter inicializado: llama-3.3-70b-versatile
INFO:app.core.llm_gemini_adapter:Chamada Gemini SDK (tentativa 1/5)
INFO:app.core.llm_gemini_adapter:Chamada Gemini concluÝda.
INFO:app.services.query_interpreter:Intent classificado: IntentType.VENDAS (confianþa: 0.95)
INFO:app.services.query_interpreter:Intent classificado: IntentType.VENDAS (confianþa: 0.95)
INFO:app.services.chat_service_v3:Intent: IntentType.VENDAS (confianþa: 0.95)
INFO:app.services.metrics_calculator:MÚtricas calculadas: 498801 linhas em 509.56ms
INFO:app.services.chat_service_v3:MÚtricas calculadas: 498801 linhas em 510ms
INFO:app.services.metrics_validator:\u2705 MÚtricas validadas com sucesso: 498801 linhas, 3 mÚtricas
INFO:app.services.context_builder:Construindo contexto para intent: IntentType.VENDAS
INFO:app.services.context_builder:Contexto construÝdo: ~255 tokens
INFO:app.services.chat_service_v3:Contexto construÝdo: ~255 tokens
ERROR:app.core.utils.session_manager:Invalid session_id format (potential path traversal): test_session
ERROR:app.services.chat_service_v3:ValueError: Invalid session_id format
Traceback (most recent call last):
  File "C:\Agente_BI\BI_Solution\backend\app\core\utils\session_manager.py", line 18, in _get_file_path
    uuid.UUID(session_id)
  File "C:\Program Files\Python311\Lib\uuid.py", line 178, in __init__
    raise ValueError('badly formed hexadecimal UUID string')
ValueError: badly formed hexadecimal UUID string

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Agente_BI\BI_Solution\backend\app\services\chat_service_v3.py", line 186, in process_message
    chat_history = self.session_manager.get_history(session_id, user_id)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Agente_BI\BI_Solution\backend\app\core\utils\session_manager.py", line 30, in get_history
    file_path = self._get_file_path(session_id)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Agente_BI\BI_Solution\backend\app\core\utils\session_manager.py", line 24, in _get_file_path
    raise ValueError("Invalid session_id format")
ValueError: Invalid session_id format
=== INICIANDO TESTE DECEP KNOWLEDGE (1000% CHECK) ===

--- QUERY: Quais colunas vocÛ tem acesso no banco de dados? ---
RESPOSTA TYPE: validation_error
MENSAGEM: ParÔmetros invßlidos: Invalid session_id format...
Traceback (most recent call last):
  File "C:\Agente_BI\BI_Solution\backend\test_deep_knowledge.py", line 52, in test_deep_knowledge
    print("\u274c TESTE 1 (SCHEMA): FALHOU (NÒo listou colunas)")
  File "C:\Program Files\Python311\Lib\encodings\cp1252.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_table)[0]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
UnicodeEncodeError: 'charmap' codec can't encode character '\u274c' in position 0: character maps to <undefined>

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Agente_BI\BI_Solution\backend\test_deep_knowledge.py", line 69, in <module>
    asyncio.run(test_deep_knowledge())
  File "C:\Program Files\Python311\Lib\asyncio\runners.py", line 190, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\asyncio\runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\asyncio\base_events.py", line 650, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "C:\Agente_BI\BI_Solution\backend\test_deep_knowledge.py", line 62, in test_deep_knowledge
    print(f"\u274c ERRO GRAVE: {e}")
  File "C:\Program Files\Python311\Lib\encodings\cp1252.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_table)[0]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
UnicodeEncodeError: 'charmap' codec can't encode character '\u274c' in position 0: character maps to <undefined>
