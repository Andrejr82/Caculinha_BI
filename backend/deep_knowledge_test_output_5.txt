INFO:app.services.chat_service_v3:Inicializando ChatServiceV3 (Metrics-First)...
INFO:app.core.llm_factory:SmartLLM initialized: primary=google, gemini_available=True
INFO:app.services.metrics_calculator:MetricsCalculator inicializado com parquet: C:\Agente_BI\BI_Solution\data\parquet\admmat.parquet
INFO:app.services.chat_service_v3:\u2705 ChatServiceV3 inicializado com sucesso
INFO:app.services.chat_service_v3:[V3] Processando query: 'Quais colunas vocÛ tem acesso no banco de dados?...'
INFO:app.services.query_interpreter:Interpretando query: 'Quais colunas vocÛ tem acesso no banco de dados?...'
INFO:app.services.query_interpreter:HeurÝstica falhou ou baixa confianþa. Usando LLM fallback...
INFO:app.core.llm_gemini_adapter:Gemini adapter inicializado com modelo: gemini-2.5-flash-lite
INFO:app.core.llm_groq_adapter:[OK] GroqLLMAdapter inicializado: llama-3.3-70b-versatile
INFO:app.core.llm_gemini_adapter:Chamada Gemini SDK (tentativa 1/5)
INFO:app.core.llm_gemini_adapter:Chamada Gemini concluÝda.
INFO:app.services.query_interpreter:Intent classificado: IntentType.ESTOQUE (confianþa: 0.95)
INFO:app.services.query_interpreter:Intent classificado: IntentType.ESTOQUE (confianþa: 0.95)
INFO:app.services.chat_service_v3:Intent: IntentType.ESTOQUE (confianþa: 0.95)
ERROR:app.services.metrics_calculator:Erro ao calcular estoque: Binder Error: No function matches the given name and argument types 'sum(VARCHAR)'. You might need to add explicit type casts.
	Candidate functions:
	sum(DECIMAL) -> DECIMAL
	sum(BOOLEAN) -> HUGEINT
	sum(SMALLINT) -> HUGEINT
	sum(INTEGER) -> HUGEINT
	sum(BIGINT) -> HUGEINT
	sum(HUGEINT) -> HUGEINT
	sum(DOUBLE) -> DOUBLE
	sum(BIGNUM) -> BIGNUM


LINE 3:             SUM(ESTOQUE_UNE) as total_estoque,
                    ^
ERROR:app.services.chat_service_v3:Erro no processamento: Binder Error: No function matches the given name and argument types 'sum(VARCHAR)'. You might need to add explicit type casts.
	Candidate functions:
	sum(DECIMAL) -> DECIMAL
	sum(BOOLEAN) -> HUGEINT
	sum(SMALLINT) -> HUGEINT
	sum(INTEGER) -> HUGEINT
	sum(BIGINT) -> HUGEINT
	sum(HUGEINT) -> HUGEINT
	sum(DOUBLE) -> DOUBLE
	sum(BIGNUM) -> BIGNUM


LINE 3:             SUM(ESTOQUE_UNE) as total_estoque,
                    ^
Traceback (most recent call last):
  File "C:\Agente_BI\BI_Solution\backend\app\services\chat_service_v3.py", line 157, in process_message
    metrics = await asyncio.to_thread(
              ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\asyncio\threads.py", line 25, in to_thread
    return await loop.run_in_executor(None, func_call)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Agente_BI\BI_Solution\backend\app\services\metrics_calculator.py", line 112, in calculate
    result = self._calculate_estoque(filters, aggregations)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Agente_BI\BI_Solution\backend\app\services\metrics_calculator.py", line 282, in _calculate_estoque
    result_df = self.conn.execute(query, params).df()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_duckdb.BinderException: Binder Error: No function matches the given name and argument types 'sum(VARCHAR)'. You might need to add explicit type casts.
	Candidate functions:
	sum(DECIMAL) -> DECIMAL
	sum(BOOLEAN) -> HUGEINT
	sum(SMALLINT) -> HUGEINT
	sum(INTEGER) -> HUGEINT
	sum(BIGINT) -> HUGEINT
	sum(HUGEINT) -> HUGEINT
	sum(DOUBLE) -> DOUBLE
	sum(BIGNUM) -> BIGNUM


LINE 3:             SUM(ESTOQUE_UNE) as total_estoque,
                    ^
=== INICIANDO TESTE DECEP KNOWLEDGE (1000% CHECK) ===

--- QUERY: Quais colunas vocÛ tem acesso no banco de dados? ---
RESPOSTA TYPE: error
MENSAGEM: Erro ao processar sua solicitaþÒo. Por favor, tente novamente....
Traceback (most recent call last):
  File "C:\Agente_BI\BI_Solution\backend\test_deep_knowledge.py", line 54, in test_deep_knowledge
    print("\u274c TESTE 1 (SCHEMA): FALHOU (NÒo listou colunas)")
  File "C:\Program Files\Python311\Lib\encodings\cp1252.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_table)[0]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
UnicodeEncodeError: 'charmap' codec can't encode character '\u274c' in position 0: character maps to <undefined>

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Agente_BI\BI_Solution\backend\test_deep_knowledge.py", line 71, in <module>
    asyncio.run(test_deep_knowledge())
  File "C:\Program Files\Python311\Lib\asyncio\runners.py", line 190, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\asyncio\runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\asyncio\base_events.py", line 650, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "C:\Agente_BI\BI_Solution\backend\test_deep_knowledge.py", line 64, in test_deep_knowledge
    print(f"\u274c ERRO GRAVE: {e}")
  File "C:\Program Files\Python311\Lib\encodings\cp1252.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_table)[0]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
UnicodeEncodeError: 'charmap' codec can't encode character '\u274c' in position 0: character maps to <undefined>
