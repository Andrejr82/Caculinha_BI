INFO:app.services.chat_service_v3:Inicializando ChatServiceV3 (Metrics-First)...
INFO:app.core.llm_factory:SmartLLM initialized: primary=google, gemini_available=True
INFO:app.services.metrics_calculator:MetricsCalculator inicializado com parquet: C:\Agente_BI\BI_Solution\data\parquet\admmat.parquet
INFO:app.services.chat_service_v3:\u2705 ChatServiceV3 inicializado com sucesso
INFO:app.services.chat_service_v3:[V3] Processando query: 'Quais colunas vocÛ tem acesso no banco de dados?...'
INFO:app.services.query_interpreter:Interpretando query: 'Quais colunas vocÛ tem acesso no banco de dados?...'
INFO:app.services.query_interpreter:HeurÝstica falhou ou baixa confianþa. Usando LLM fallback...
INFO:app.core.llm_gemini_adapter:Gemini adapter inicializado com modelo: gemini-2.5-flash-lite
INFO:app.core.llm_groq_adapter:[OK] GroqLLMAdapter inicializado: llama-3.3-70b-versatile
INFO:app.core.llm_gemini_adapter:Chamada Gemini SDK (tentativa 1/5)
INFO:app.core.llm_gemini_adapter:Chamada Gemini concluÝda.
WARNING:app.services.query_interpreter:Erro ao decodificar JSON da LLM: Extra data: line 3 column 1 (char 70). Raw: # \U0001f9e0 CHAIN-OF-THOUGHT (RaciocÝnio Passo a Passo)

Antes de classificar, analise:
1. **IntenþÒo Principal:** O que o usußrio quer? (vendas, estoque, ruptura, comparaþÒo, grßfico)
2. **Entidades EspecÝficas:** Hß loja, produto, segmento ou perÝodo mencionados?
3. **VisualizaþÒo:** O usußrio quer ver um grßfico, tabela ou apenas dados?
4. **Confianþa:** QuÒo certo estou da classificaþÒo? (0.0 = incerto, 1.0 = certeza total)

---

# \U0001f4a1 EXEMPLOS (FEW-SHOT LEARNING)

**Exemplo 1:**
Query: "Como estÒo as vendas da loja 1685?"
RaciocÝnio:
- IntenþÒo: VENDAS (palavra-chave clara)
- Entidades: UNE=1685 (loja especÝfica)
- VisualizaþÒo: NÒo solicitada explicitamente
- Confianþa: 0.95 (muito claro)
Resposta: {"intent_type": "vendas", "confidence": 0.95, "visualization": null}

**Exemplo 2:**
Query: "Mostre um grßfico de rupturas"
RaciocÝnio:
- IntenþÒo: RUPTURA (palavra-chave "rupturas")
- Entidades: Nenhuma especÝfica (anßlise geral)
- VisualizaþÒo: "grßfico" solicitado explicitamente
- Confianþa: 0.90 (claro, mas sem entidades)
Resposta: {"intent_type": "ruptura", "confidence": 0.90, "visualization": "auto"}

**Exemplo 3:**
Query: "Compare vendas das lojas 1685 e 2365"
RaciocÝnio:
- IntenþÒo: COMPARACAO (palavra-chave "compare")
- Entidades: UNEs=1685,2365 (m·ltiplas lojas)
- VisualizaþÒo: ImplÝcita (comparaþÒo geralmente usa grßfico)
- Confianþa: 0.92 (muito claro)
Resposta: {"intent_type": "comparacao", "confidence": 0.92, "visualization": "bar"}

**Exemplo 4:**
Query: "Quanto tem em estoque de tecidos?"
RaciocÝnio:
- IntenþÒo: ESTOQUE (palavra-chave "estoque")
- Entidades: Segmento=TECIDOS
- VisualizaþÒo: NÒo solicitada
- Confianþa: 0.88 (claro)
Resposta: {"intent_type": "estoque", "confidence": 0.88, "visualization": null}

**Exemplo 5:**
Query: "Gere um grßfico de vendas por categoria"
RaciocÝnio:
- IntenþÒo: GRAFICO (foco principal Ú visualizaþÒo)
- Entidades: Agrupamento por categoria
- VisualizaþÒo: "grßfico" explÝcito
- Confianþa: 0.95 (muito claro)
Resposta: {"intent_type": "grafico", "confidence": 0.95, "visualization": "auto"}

---

# \U0001f3af TAREFA

Query do usußrio: "Quais foram as vendas da loja 1234 no ·ltimo mÛs?"

**Seu raciocÝnio (pense em voz alta):**
1. IntenþÒo: A palavra-chave "vendas" indica claramente a intenþÒo principal.
2. Entidades: A query menciona "loja 1234" (entidade UNE) e "·ltimo mÛs" (entidade perÝodo).
3. VisualizaþÒo: NÒo hß solicitaþÒo explÝcita de visualizaþÒo (grßfico, tabela), entÒo o padrÒo Ú null.
4. Confianþa: A query Ú direta e contÚm todas as informaþ§es necessßrias para a classificaþÒo, resultando em alta confianþa.

**Resposta (APENAS JSON vßlido):**
{{
  "intent_type": "vendas",
  "entities": {{ "une": 1234, "periodo": "30d" }},
  "confidence": 0.98,
  "visualization": null
}}

JSON:
```json
{
  "intent_type": "vendas",
  "entities": {
    "une": 1234,
    "periodo": "30d"
  },
  "confidence": 0.98,
  "visualization": null
}
```
WARNING:app.services.query_interpreter:Confianþa muito baixa (0.5). Pedindo esclarecimento.
WARNING:app.services.chat_service_v3:NeedsClarificationError: NÒo entendi sua pergunta. Pode reformular de forma mais especÝfica? Por exemplo: 'Quais as vendas da loja 1685?' ou 'Mostre o estoque de tecidos'
=== INICIANDO TESTE DECEP KNOWLEDGE (1000% CHECK) ===

Traceback (most recent call last):
  File "C:\Agente_BI\BI_Solution\backend\test_deep_knowledge.py", line 54, in test_deep_knowledge
--- QUERY: Quais colunas vocÛ tem acesso no banco de dados? ---
RESPOSTA TYPE: clarification_needed
MENSAGEM: NÒo entendi sua pergunta. Pode reformular de forma mais especÝfica? Por exemplo: 'Quais as vendas da loja 1685?' ou 'Mostre o estoque de tecidos'...
    print("\u274c TESTE 1 (SCHEMA): FALHOU (NÒo listou colunas)")
  File "C:\Program Files\Python311\Lib\encodings\cp1252.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_table)[0]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
UnicodeEncodeError: 'charmap' codec can't encode character '\u274c' in position 0: character maps to <undefined>

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Agente_BI\BI_Solution\backend\test_deep_knowledge.py", line 71, in <module>
    asyncio.run(test_deep_knowledge())
  File "C:\Program Files\Python311\Lib\asyncio\runners.py", line 190, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\asyncio\runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\asyncio\base_events.py", line 650, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "C:\Agente_BI\BI_Solution\backend\test_deep_knowledge.py", line 64, in test_deep_knowledge
    print(f"\u274c ERRO GRAVE: {e}")
  File "C:\Program Files\Python311\Lib\encodings\cp1252.py", line 19, in encode
    return codecs.charmap_encode(input,self.errors,encoding_table)[0]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
UnicodeEncodeError: 'charmap' codec can't encode character '\u274c' in position 0: character maps to <undefined>
