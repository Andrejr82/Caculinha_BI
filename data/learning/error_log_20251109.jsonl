{"timestamp": "2025-11-09T13:36:08.639654", "query": "\n            **TAREFA:** Você deve escrever um script Python para responder à pergunta do usuário.\n\n            **INSTRUÇÕES OBRIGATÓRIAS:**\n            1. **CARREGUE OS DADOS:** Inicie seu script com a linha: `df = load_data()`\n            2. **RESPONDA À PERGUNTA:** Usando o dataframe `df`, escreva o código para responder à seguinte pergunta: \"qual disponivel no estoque_cd dos produtos do segmento tecidos em ruptura na une 261\"\n            3. **SALVE O RESULTADO NA VARIÁVEL `result`:** A última linha do seu script DEVE ser a atribuição do resultado final à variável `result`. Esta é a única forma que o sistema tem para ver sua resposta. NÃO use `print()`.\n\n            **REGRAS OBRIGATÓRIAS:**\n            1. **SEMPRE defina variáveis antes de usar:** Se usar `produto_id`, defina antes (ex: `produto_id = 369947`)\n            2. **Produtos em Excesso:** Filtre `estoque_atual > linha_verde`\n            3. **\"linha verde\" NÃO é segmento:** É uma COLUNA (linha_verde) que indica meta de estoque\n            4. **Produtos que precisam ajuste na linha verde:** Filtre onde `estoque_atual != linha_verde`\n            5. **UNE:** Filtre por `une_nome` (ex: 'BON', 'TAQ', 'TIJ'), NÃO por código numérico\n            6. **Análise Temporal:** Dataset só tem venda_30_d (últimos 30 dias). NÃO há colunas de mês/trimestre\n            7. **\"em todas as UNEs\":** Use merge para incluir UNEs com venda = 0\n            8. **Top N:** Use `.head(N)` após ordenar, ou `.nlargest(N, coluna)`\n\n            **Exemplo 1 - Top 10 produtos por UNE:**\n            ```python\n            df = load_data()\n            # Filtrar UNE (use nome em maiúsculas)\n            df_une = df[df['une_nome'].str.upper() == 'TIJ']\n            # Top 10 por vendas\n            top10 = df_une.nlargest(10, 'venda_30_d')[['nome_produto', 'venda_30_d']]\n            result = top10\n            ```\n\n            **Exemplo 2 - Produtos precisando ajuste na linha verde:**\n            ```python\n            df = load_data()\n            # Filtrar UNE\n            df_une = df[df['une_nome'].str.upper() == 'BON']\n            # linha_verde é COLUNA, não segmento!\n            df_ajuste = df_une[df_une['estoque_atual'] != df_une['linha_verde']]\n            result = df_ajuste[['nome_produto', 'estoque_atual', 'linha_verde']]\n            ```\n\n            **Exemplo 3 - Segmentos por vendas (NÃO há dados temporais):**\n            ```python\n            df = load_data()\n            # Filtrar UNE\n            df_une = df[df['une_nome'].str.upper() == 'TAQ']\n            # Agrupar por segmento (só temos venda_30_d, sem histórico mensal!)\n            segmentos = df_une.groupby('nomesegmento')['venda_30_d'].sum().sort_values(ascending=False)\n            result = segmentos.reset_index()\n            ```\n\n\n\n            **Seu Script Python (Lembre-se, a última linha deve ser `result = ...`):**\n            ", "code": "import pandas as pd\nimport plotly.express as px\n\n# Carregar os dados\ndf = load_data()\n\n# Definir a UNE e o segmento desejados\nune_desejada = '261'\nsegmento_desejado = 'TECIDOS'\n\n# Filtrar pela UNE especificada (usando o nome da UNE)\n# A regra 5 diz para usar une_nome, mas a pergunta usa o código numérico '261'.\n# Assumindo que '261' é um nome de UNE e não um código numérico,\n# e que os nomes das UNEs podem ser numéricos.\n# Se '261' fosse um código numérico, precisaríamos de um mapeamento ou outra coluna.\n# Para este caso, vamos tratar '261' como um nome de UNE.\ndf_une = df[df['une_nome'] == une_desejada]\n\n# Filtrar pelo segmento desejado\ndf_segmento = df_une[df_une['nomesegmento'] == segmento_desejado]\n\n# Identificar produtos em ruptura\n# Ruptura é definida como estoque_atual <= 0, ou estoque_atual <= 50% da Linha Verde.\n# A pergunta \"em ruptura\" geralmente implica estoque zero ou muito baixo.\n# Vamos considerar ruptura como estoque_atual <= 0 para ser mais restritivo.\n# Se a regra 2 (estoque_atual <= 50% da Linha Verde) for a definição de ruptura,\n# o filtro seria: df_ruptura = df_segmento[df_segmento['estoque_atual'] <= df_segmento['linha_verde'] * 0.5]\n# Para esta query, vamos assumir ruptura como estoque_atual <= 0.\ndf_ruptura = df_segmento[df_segmento['estoque_atual'] <= 0]\n\n# Selecionar a coluna 'estoque_cd' para os produtos em ruptura\n# A pergunta é \"qual disponivel no estoque_cd dos produtos do segmento tecidos em ruptura na une 261\"\n# Isso implica que queremos ver o valor de estoque_cd para esses produtos.\n# Se não houver produtos em ruptura, o resultado será um DataFrame vazio.\nif not df_ruptura.empty:\n    # Selecionar as colunas relevantes: nome_produto e estoque_cd\n    # A pergunta pede \"qual disponivel no estoque_cd\", então vamos retornar o valor de estoque_cd\n    # e o nome do produto para identificação.\n    resultado_ruptura = df_ruptura[['nome_produto', 'estoque_cd']]\nelse:\n    # Se não houver produtos em ruptura, retornar um DataFrame vazio com as colunas esperadas\n    resultado_ruptura = pd.DataFrame(columns=['nome_produto', 'estoque_cd'])\n\n# Atribuir o resultado à variável 'result'\nresult = resultado_ruptura.head(10)", "error_type": "ColumnValidationError", "error_message": "Coluna '[' não encontrada no DataFrame.\n\nColunas disponíveis:\n", "success": false}
{"timestamp": "2025-11-09T17:59:51.805806", "query": "\n            **TAREFA:** Você deve escrever um script Python para responder à pergunta do usuário.\n\n            **INSTRUÇÕES OBRIGATÓRIAS:**\n            1. **CARREGUE OS DADOS:** Inicie seu script com a linha: `df = load_data()`\n            2. **RESPONDA À PERGUNTA:** Usando o dataframe `df`, escreva o código para responder à seguinte pergunta: \"gere um relatório de todos os produtos da kit sem vendas nas unes com a quantidade de embalagem master ou multiplo\"\n            3. **SALVE O RESULTADO NA VARIÁVEL `result`:** A última linha do seu script DEVE ser a atribuição do resultado final à variável `result`. Esta é a única forma que o sistema tem para ver sua resposta. NÃO use `print()`.\n\n            **REGRAS OBRIGATÓRIAS:**\n            1. **SEMPRE defina variáveis antes de usar:** Se usar `produto_id`, defina antes (ex: `produto_id = 369947`)\n            2. **Produtos em Excesso:** Filtre `estoque_atual > linha_verde`\n            3. **\"linha verde\" NÃO é segmento:** É uma COLUNA (linha_verde) que indica meta de estoque\n            4. **Produtos que precisam ajuste na linha verde:** Filtre onde `estoque_atual != linha_verde`\n            5. **UNE:** Filtre por `une_nome` (ex: 'BON', 'TAQ', 'TIJ'), NÃO por código numérico\n            6. **Análise Temporal:** Dataset só tem venda_30_d (últimos 30 dias). NÃO há colunas de mês/trimestre\n            7. **\"em todas as UNEs\":** Use merge para incluir UNEs com venda = 0\n            8. **Top N:** Use `.head(N)` após ordenar, ou `.nlargest(N, coluna)`\n\n            **Exemplo 1 - Top 10 produtos por UNE:**\n            ```python\n            df = load_data()\n            # Filtrar UNE (use nome em maiúsculas)\n            df_une = df[df['une_nome'].str.upper() == 'TIJ']\n            # Top 10 por vendas\n            top10 = df_une.nlargest(10, 'venda_30_d')[['nome_produto', 'venda_30_d']]\n            result = top10\n            ```\n\n            **Exemplo 2 - Produtos precisando ajuste na linha verde:**\n            ```python\n            df = load_data()\n            # Filtrar UNE\n            df_une = df[df['une_nome'].str.upper() == 'BON']\n            # linha_verde é COLUNA, não segmento!\n            df_ajuste = df_une[df_une['estoque_atual'] != df_une['linha_verde']]\n            result = df_ajuste[['nome_produto', 'estoque_atual', 'linha_verde']]\n            ```\n\n            **Exemplo 3 - Segmentos por vendas (NÃO há dados temporais):**\n            ```python\n            df = load_data()\n            # Filtrar UNE\n            df_une = df[df['une_nome'].str.upper() == 'TAQ']\n            # Agrupar por segmento (só temos venda_30_d, sem histórico mensal!)\n            segmentos = df_une.groupby('nomesegmento')['venda_30_d'].sum().sort_values(ascending=False)\n            result = segmentos.reset_index()\n            ```\n\n\n\n            **Seu Script Python (Lembre-se, a última linha deve ser `result = ...`):**\n            ", "code": "import pandas as pd\n\n# Carrega os dados\ndf = load_data()\n\n# Define o fabricante a ser filtrado\nfabricante_filtro = 'KIT'\n\n# Verifica se as colunas necessárias existem no DataFrame\ncolunas_necessarias = ['NOMEFABRICANTE', 'venda_30_d', 'une_nome', 'estoque_atual', 'linha_verde']\n# Validação rígida removida automaticamente\n\n# Filtra os produtos do fabricante 'KIT'\ndf_kit = df[df['NOMEFABRICANTE'] == fabricante_filtro].copy()\n\n# Identifica os produtos sem vendas nas UNEs\n# Para garantir que todos os produtos do KIT sejam considerados, mesmo aqueles sem vendas em nenhuma UNE,\n# vamos primeiro obter a lista de todos os produtos do KIT.\ntodos_produtos_kit = df_kit['codigo'].unique()\n\n# Cria um DataFrame com todas as UNEs e todos os produtos do KIT\n# Isso garante que produtos do KIT sem vendas em nenhuma UNE sejam incluídos.\ntodas_unes = df['une_nome'].unique()\ndf_todas_unes_kit = pd.MultiIndex.from_product([todas_unes, todos_produtos_kit], names=['une_nome', 'codigo']).to_frame(index=False)\n\n# Junta com o DataFrame original para obter informações de venda e estoque\ndf_completo_kit = pd.merge(df_todas_unes_kit, df, on=['codigo', 'une_nome'], how='left')\n\n# Preenche valores nulos de venda com 0 para produtos sem vendas registradas\ndf_completo_kit['venda_30_d'] = df_completo_kit['venda_30_d'].fillna(0)\n\n# Filtra os produtos que não tiveram vendas (venda_30_d == 0)\ndf_sem_vendas = df_completo_kit[df_completo_kit['venda_30_d'] == 0]\n\n# Seleciona as colunas relevantes para o relatório\n# Inclui 'estoque_atual' e 'linha_verde' para análise posterior, se necessário.\n# A pergunta pede \"quantidade de embalagem master ou multiplo\", que não está diretamente disponível.\n# Assumindo que 'estoque_atual' representa a quantidade total em estoque.\n# Se houver colunas específicas para 'embalagem master' ou 'multiplo', elas deveriam ser usadas.\n# Como não há, usaremos 'estoque_atual' como a quantidade disponível.\nrelatorio_kit_sem_vendas = df_sem_vendas[['nome_produto', 'une_nome', 'estoque_atual']].copy()\n\n# Ordena o resultado para melhor visualização (opcional, mas recomendado)\nrelatorio_kit_sem_vendas = relatorio_kit_sem_vendas.sort_values(by=['nome_produto', 'une_nome'])\n\n# O resultado final é o DataFrame com os produtos do KIT sem vendas em nenhuma UNE,\n# juntamente com a UNE e a quantidade em estoque.\nresult = relatorio_kit_sem_vendas.head(10)", "error_type": "ColumnValidationError", "error_message": "Coluna 'NOMEFABRICANTE' não encontrada no DataFrame.\n\nColunas disponíveis:\n", "success": false}
{"timestamp": "2025-11-09T18:01:49.962334", "query": "\n            **TAREFA:** Você deve escrever um script Python para responder à pergunta do usuário.\n\n            **INSTRUÇÕES OBRIGATÓRIAS:**\n            1. **CARREGUE OS DADOS:** Inicie seu script com a linha: `df = load_data()`\n            2. **RESPONDA À PERGUNTA:** Usando o dataframe `df`, escreva o código para responder à seguinte pergunta: \"gere um relatório de todos os produtos da kit sem vendas nas unes com a quantidade de embalagem master ou multiplo\"\n            3. **SALVE O RESULTADO NA VARIÁVEL `result`:** A última linha do seu script DEVE ser a atribuição do resultado final à variável `result`. Esta é a única forma que o sistema tem para ver sua resposta. NÃO use `print()`.\n\n            **REGRAS OBRIGATÓRIAS:**\n            1. **SEMPRE defina variáveis antes de usar:** Se usar `produto_id`, defina antes (ex: `produto_id = 369947`)\n            2. **Produtos em Excesso:** Filtre `estoque_atual > linha_verde`\n            3. **\"linha verde\" NÃO é segmento:** É uma COLUNA (linha_verde) que indica meta de estoque\n            4. **Produtos que precisam ajuste na linha verde:** Filtre onde `estoque_atual != linha_verde`\n            5. **UNE:** Filtre por `une_nome` (ex: 'BON', 'TAQ', 'TIJ'), NÃO por código numérico\n            6. **Análise Temporal:** Dataset só tem venda_30_d (últimos 30 dias). NÃO há colunas de mês/trimestre\n            7. **\"em todas as UNEs\":** Use merge para incluir UNEs com venda = 0\n            8. **Top N:** Use `.head(N)` após ordenar, ou `.nlargest(N, coluna)`\n\n            **Exemplo 1 - Top 10 produtos por UNE:**\n            ```python\n            df = load_data()\n            # Filtrar UNE (use nome em maiúsculas)\n            df_une = df[df['une_nome'].str.upper() == 'TIJ']\n            # Top 10 por vendas\n            top10 = df_une.nlargest(10, 'venda_30_d')[['nome_produto', 'venda_30_d']]\n            result = top10\n            ```\n\n            **Exemplo 2 - Produtos precisando ajuste na linha verde:**\n            ```python\n            df = load_data()\n            # Filtrar UNE\n            df_une = df[df['une_nome'].str.upper() == 'BON']\n            # linha_verde é COLUNA, não segmento!\n            df_ajuste = df_une[df_une['estoque_atual'] != df_une['linha_verde']]\n            result = df_ajuste[['nome_produto', 'estoque_atual', 'linha_verde']]\n            ```\n\n            **Exemplo 3 - Segmentos por vendas (NÃO há dados temporais):**\n            ```python\n            df = load_data()\n            # Filtrar UNE\n            df_une = df[df['une_nome'].str.upper() == 'TAQ']\n            # Agrupar por segmento (só temos venda_30_d, sem histórico mensal!)\n            segmentos = df_une.groupby('nomesegmento')['venda_30_d'].sum().sort_values(ascending=False)\n            result = segmentos.reset_index()\n            ```\n\n\n\n            **Seu Script Python (Lembre-se, a última linha deve ser `result = ...`):**\n            ", "code": "import pandas as pd\n\n# Carrega os dados\ndf = load_data()\n\n# Define o fabricante a ser filtrado\nfabricante_filtro = 'KIT'\n\n# Verifica se as colunas necessárias existem no DataFrame\ncolunas_necessarias = ['NOMEFABRICANTE', 'venda_30_d', 'une_nome', 'estoque_atual', 'linha_verde']\n# Validação rígida removida automaticamente\n\n# Filtra os produtos do fabricante 'KIT'\ndf_kit = df[df['NOMEFABRICANTE'] == fabricante_filtro].copy()\n\n# Identifica os produtos sem vendas nas UNEs\n# Para garantir que todos os produtos do KIT sejam considerados, mesmo aqueles sem vendas em nenhuma UNE,\n# vamos primeiro obter a lista de todos os produtos do KIT.\ntodos_produtos_kit = df_kit['codigo'].unique()\n\n# Cria um DataFrame com todas as UNEs e todos os produtos do KIT\n# Isso garante que produtos do KIT sem vendas em nenhuma UNE sejam incluídos.\ntodas_unes = df['une_nome'].unique()\ndf_todas_unes_kit = pd.MultiIndex.from_product([todas_unes, todos_produtos_kit], names=['une_nome', 'codigo']).to_frame(index=False)\n\n# Junta com o DataFrame original para obter informações de venda e estoque\ndf_completo_kit = pd.merge(df_todas_unes_kit, df, on=['codigo', 'une_nome'], how='left')\n\n# Preenche valores nulos de venda com 0 para produtos sem vendas registradas\ndf_completo_kit['venda_30_d'] = df_completo_kit['venda_30_d'].fillna(0)\n\n# Filtra os produtos que não tiveram vendas (venda_30_d == 0)\ndf_sem_vendas = df_completo_kit[df_completo_kit['venda_30_d'] == 0]\n\n# Seleciona as colunas relevantes para o relatório\n# Inclui 'estoque_atual' e 'linha_verde' para análise posterior, se necessário.\n# A pergunta pede \"quantidade de embalagem master ou multiplo\", que não está diretamente disponível.\n# Assumindo que 'estoque_atual' representa a quantidade total em estoque.\n# Se houver colunas específicas para 'embalagem master' ou 'multiplo', elas deveriam ser usadas.\n# Como não há, usaremos 'estoque_atual' como a quantidade disponível.\nrelatorio_kit_sem_vendas = df_sem_vendas[['nome_produto', 'une_nome', 'estoque_atual']].copy()\n\n# Ordena o resultado para melhor visualização (opcional, mas recomendado)\nrelatorio_kit_sem_vendas = relatorio_kit_sem_vendas.sort_values(by=['nome_produto', 'une_nome'])\n\n# O resultado final é o DataFrame com os produtos do KIT sem vendas em nenhuma UNE,\n# juntamente com a UNE e a quantidade em estoque.\nresult = relatorio_kit_sem_vendas.head(10)", "error_type": "ColumnValidationError", "error_message": "Coluna 'NOMEFABRICANTE' não encontrada no DataFrame.\n\nColunas disponíveis:\n", "success": false}
{"timestamp": "2025-11-09T19:12:18.133328", "query": "\n            \n            **TAREFA:** Você deve escrever um script Python para responder à pergunta do usuário.\n\n            **INSTRUÇÕES OBRIGATÓRIAS:**\n            1. **CARREGUE OS DADOS:** Inicie seu script com a linha: `df = load_data()`\n            2. **RESPONDA À PERGUNTA:** Usando o dataframe `df`, escreva o código para responder à seguinte pergunta: \"gere um relatório de todos os produtos da kit sem vendas nas unes com a quantidade de embalagem master ou multiplo\"\n            3. **SALVE O RESULTADO NA VARIÁVEL `result`:** A última linha do seu script DEVE ser a atribuição do resultado final à variável `result`. Esta é a única forma que o sistema tem para ver sua resposta. NÃO use `print()`.\n\n            **REGRAS OBRIGATÓRIAS:**\n            1. **SEMPRE defina variáveis antes de usar:** Se usar `produto_id`, defina antes (ex: `produto_id = 369947`)\n            2. **Produtos em Excesso:** Filtre `estoque_atual > linha_verde`\n            3. **\"linha verde\" NÃO é segmento:** É uma COLUNA (linha_verde) que indica meta de estoque\n            4. **Produtos que precisam ajuste na linha verde:** Filtre onde `estoque_atual != linha_verde`\n            5. **UNE:** Filtre por `une_nome` (ex: 'BON', 'TAQ', 'TIJ'), NÃO por código numérico\n            6. **Análise Temporal:** Dataset só tem venda_30_d (últimos 30 dias). NÃO há colunas de mês/trimestre\n            7. **\"em todas as UNEs\":** Use merge para incluir UNEs com venda = 0\n            8. **Top N:** Use `.head(N)` após ordenar, ou `.nlargest(N, coluna)`\n\n            **Exemplo 1 - Top 10 produtos por UNE:**\n            ```python\n            df = load_data()\n            # Filtrar UNE (use nome em maiúsculas)\n            df_une = df[df['une_nome'].str.upper() == 'TIJ']\n            # Top 10 por vendas\n            top10 = df_une.nlargest(10, 'venda_30_d')[['nome_produto', 'venda_30_d']]\n            result = top10\n            ```\n\n            **Exemplo 2 - Produtos precisando ajuste na linha verde:**\n            ```python\n            df = load_data()\n            # Filtrar UNE\n            df_une = df[df['une_nome'].str.upper() == 'BON']\n            # linha_verde é COLUNA, não segmento!\n            df_ajuste = df_une[df_une['estoque_atual'] != df_une['linha_verde']]\n            result = df_ajuste[['nome_produto', 'estoque_atual', 'linha_verde']]\n            ```\n\n            **Exemplo 3 - Segmentos por vendas (NÃO há dados temporais):**\n            ```python\n            df = load_data()\n            # Filtrar UNE\n            df_une = df[df['une_nome'].str.upper() == 'TAQ']\n            # Agrupar por segmento (só temos venda_30_d, sem histórico mensal!)\n            segmentos = df_une.groupby('nomesegmento')['venda_30_d'].sum().sort_values(ascending=False)\n            result = segmentos.reset_index()\n            ```\n\n\n\n            **Seu Script Python (Lembre-se, a última linha deve ser `result = ...`):**\n            ", "code": "df = load_data()\n\n# Verificar se as colunas necessárias existem\nrequired_columns = ['NOMEFABRICANTE', 'venda_30_d', 'estoque_atual', 'linha_verde', 'une_nome', 'quantidade_embalagem_master', 'quantidade_multiplo']\nfor col in required_columns:\n    if col not in df.columns:\n        raise ValueError(f\"Coluna obrigatória '{col}' não encontrada no DataFrame.\")\n\n# Filtrar produtos do fabricante 'KIT'\ndf_kit = df[df['NOMEFABRICANTE'] == 'KIT'].copy()\n\n# Filtrar produtos sem vendas nos últimos 30 dias\ndf_sem_vendas = df_kit[df_kit['venda_30_d'] == 0].copy()\n\n# Filtrar produtos em excesso (estoque_atual > linha_verde)\ndf_em_excesso = df_sem_vendas[df_sem_vendas['estoque_atual'] > df_sem_vendas['linha_verde']].copy()\n\n# Filtrar produtos que precisam de ajuste na linha verde (estoque_atual != linha_verde)\ndf_ajuste_linha_verde = df_em_excesso[df_em_excesso['estoque_atual'] != df_em_excesso['linha_verde']].copy()\n\n# Obter a lista de todas as UNEs\ntodas_unes = df['une_nome'].unique()\n\n# Criar um DataFrame com todas as UNEs para garantir que todas sejam incluídas\ndf_todas_unes = pd.DataFrame({'une_nome': todas_unes})\n\n# Merge para incluir UNEs com venda = 0\n# Primeiro, renomeamos as colunas de quantidade para evitar conflito no merge\ndf_ajuste_linha_verde_renomeado = df_ajuste_linha_verde.rename(columns={\n    'quantidade_embalagem_master': 'quantidade_embalagem_master_ajuste',\n    'quantidade_multiplo': 'quantidade_multiplo_ajuste'\n})\n\n# Selecionar colunas relevantes antes do merge\ncolunas_selecionadas = ['codigo', 'nome_produto', 'une_nome', 'estoque_atual', 'linha_verde', 'quantidade_embalagem_master_ajuste', 'quantidade_multiplo_ajuste']\ndf_ajuste_linha_verde_selecionado = df_ajuste_linha_verde_renomeado[colunas_selecionadas]\n\n# Realizar o merge com todas as UNEs\n# Usamos 'left' merge para manter todos os produtos do df_ajuste_linha_verde_selecionado\n# e adicionar as colunas de quantidade onde houver correspondência.\n# Para UNEs que não estão no df_ajuste_linha_verde_selecionado, as colunas de quantidade serão NaN.\n# Precisamos garantir que estamos juntando com base no produto correto.\n# Vamos assumir que 'codigo' é o identificador único do produto.\n\n# Criar um DataFrame base com produtos e suas quantidades\ndf_produtos_quantidades = df_ajuste_linha_verde_selecionado[['codigo', 'nome_produto', 'quantidade_embalagem_master_ajuste', 'quantidade_multiplo_ajuste']].drop_duplicates(subset=['codigo'])\n\n# Criar um DataFrame com todas as combinações de produto e UNE\n# Isso é necessário para garantir que todos os produtos sejam listados para todas as UNEs,\n# mesmo que não tenham vendas ou estejam em excesso em uma UNE específica.\n# No entanto, a pergunta é \"sem vendas nas unes\", o que implica que estamos interessados\n# nos produtos que *não* tiveram vendas em *nenhuma* UNE.\n\n# Vamos reinterpretar: \"gerar um relatório de todos os produtos da kit sem vendas nas unes\"\n# Isso significa que o produto em si não teve vendas em NENHUMA UNE.\n# E \"com a quantidade de embalagem master ou multiplo\" refere-se às quantidades desses produtos.\n\n# Primeiro, encontramos os produtos da KIT que não tiveram vendas em NENHUMA UNE.\n# Para isso, vamos agrupar por produto e somar as vendas em todas as UNEs.\ndf_vendas_por_produto_kit = df_kit.groupby('codigo').agg(\n    total_venda_30_d=('venda_30_d', 'sum'),\n    nome_produto=('nome_produto', 'first'),\n    quantidade_embalagem_master=('quantidade_embalagem_master', 'first'),\n    quantidade_multiplo=('quantidade_multiplo', 'first')\n).head(10).reset_index()\n\n# Filtramos os produtos da KIT que têm 0 vendas totais\nprodutos_kit_sem_vendas = df_vendas_por_produto_kit[df_vendas_por_produto_kit['total_venda_30_d'] == 0].copy()\n\n# Agora, para esses produtos sem vendas, queremos saber se eles estão em excesso\n# em alguma UNE e precisam de ajuste na linha verde.\n# Precisamos juntar esses produtos com o DataFrame original para verificar as condições de estoque.\n\n# Selecionamos as colunas relevantes do DataFrame original para a verificação de estoque\ndf_estoque_completo = df[['codigo', 'une_nome', 'estoque_atual', 'linha_verde']].copy()\n\n# Juntamos os produtos sem vendas com o DataFrame de estoque completo\ndf_relatorio_completo = pd.merge(\n    produtos_kit_sem_vendas,\n    df_estoque_completo,\n    on='codigo',\n    how='left' # Usamos left merge para manter todos os produtos sem vendas\n)\n\n# Aplicamos os filtros de estoque:\n# 1. Produtos em Excesso: estoque_atual > linha_verde\n# 2. Produtos que precisam ajuste na linha verde: estoque_atual != linha_verde\ndf_relatorio_filtrado = df_relatorio_completo[\n    (df_relatorio_completo['estoque_atual'] > df_relatorio_completo['linha_verde']) &\n    (df_relatorio_completo['estoque_atual'] != df_relatorio_completo['linha_verde'])\n].copy()\n\n# Selecionamos as colunas finais para o relatório\n# Incluímos 'une_nome' para mostrar em qual UNE o produto está em excesso/precisa de ajuste.\n# Se um produto sem vendas estiver em excesso em múltiplas UNEs, ele aparecerá múltiplas vezes.\nresult = df_relatorio_filtrado[[\n    'codigo',\n    'nome_produto',\n    'une_nome',\n    'estoque_atual',\n    'linha_verde',\n    'quantidade_embalagem_master',\n    'quantidade_multiplo'\n]]\n\n# Tratamento para o caso de não haver resultados\nif result.empty:\n    result = pd.DataFrame(columns=[\n        'codigo',\n        'nome_produto',\n        'une_nome',\n        'estoque_atual',\n        'linha_verde',\n        'quantidade_embalagem_master',\n        'quantidade_multiplo'\n    ])", "error_type": "ValueError", "error_message": "Coluna obrigatória 'linha_verde' não encontrada no DataFrame.", "success": false}
