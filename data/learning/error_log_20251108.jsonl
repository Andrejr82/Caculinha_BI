{"timestamp": "2025-11-08T15:10:15.308281", "query": "\n            **TAREFA:** Você deve escrever um script Python para responder à pergunta do usuário.\n\n            **INSTRUÇÕES OBRIGATÓRIAS:**\n            1. **CARREGUE OS DADOS:** Inicie seu script com a linha: `df = load_data()`\n            2. **RESPONDA À PERGUNTA:** Usando o dataframe `df`, escreva o código para responder à seguinte pergunta: \"quais segmentos estão em queda de vendas nos ultimos 3 meses na une taq \"\n            3. **SALVE O RESULTADO NA VARIÁVEL `result`:** A última linha do seu script DEVE ser a atribuição do resultado final à variável `result`. Esta é a única forma que o sistema tem para ver sua resposta. NÃO use `print()`.\n\n            **REGRAS OBRIGATÓRIAS:**\n            1. **SEMPRE defina variáveis antes de usar:** Se usar `produto_id`, defina antes (ex: `produto_id = 369947`)\n            2. **Produtos em Excesso:** Filtre `estoque_atual > linha_verde`\n            3. **\"em todas as UNEs\":** Use merge para incluir UNEs com venda = 0\n            4. **Evite variáveis não definidas:** NÃO use `produto_id`, `une_id`, etc. sem definir primeiro\n\n            **Exemplo 1 - Gráfico simples por segmento:**\n            ```python\n            df = load_data()\n\n            # Filtrar segmento\n            df_tecidos = df[df['nomesegmento'].str.upper() == 'TECIDOS']\n\n            # Agrupar por UNE\n            vendas_une = df_tecidos.groupby('une_nome')['venda_30_d'].sum().reset_index()\n            vendas_une = vendas_une.sort_values('venda_30_d', ascending=False)\n\n            # Gráfico\n            import plotly.express as px\n            result = px.bar(vendas_une, x='une_nome', y='venda_30_d',\n                           title='Vendas Tecidos por UNE')\n            ```\n\n\n\n            **Seu Script Python (Lembre-se, a última linha deve ser `result = ...`):**\n            ", "code": "import pandas as pd\nimport plotly.express as px\n\n# Carregar os dados\ndf = load_data()\n\n# Definir a UNE de interesse\nune_interesse = 'TAQ'\n\n# Calcular as vendas dos últimos 3 meses para cada segmento\n# As colunas mes_01, mes_02, mes_03 representam os meses mais recentes\nmeses_para_analise = ['mes_01', 'mes_02', 'mes_03']\n\n# Criar um DataFrame com as vendas mensais para os últimos 3 meses\ndf_vendas_mensais = df.groupby(['une_nome', 'nomesegmento'])[meses_para_analise].sum().reset_index()\n\n# Calcular a soma das vendas dos últimos 3 meses\ndf_vendas_mensais['vendas_ultimos_3_meses'] = df_vendas_mensais[meses_para_analise].sum(axis=1)\n\n# Calcular as vendas dos 3 meses anteriores aos últimos 3 meses (para comparação de queda)\n# Assumindo que as colunas mes_04 a mes_06 representam os meses anteriores\nmeses_anteriores = ['mes_04', 'mes_05', 'mes_06']\nif all(col in df.columns for col in meses_anteriores):\n    df_vendas_mensais['vendas_meses_anteriores'] = df_vendas_mensais[meses_anteriores].sum(axis=1)\nelse:\n    # Se não houver dados suficientes para os meses anteriores, não podemos calcular a queda\n    # Neste caso, podemos retornar um DataFrame vazio ou uma mensagem de erro.\n    # Para este exemplo, vamos criar uma coluna com valor 0 para evitar erros de divisão por zero.\n    df_vendas_mensais['vendas_meses_anteriores'] = 0\n\n# Filtrar pela UNE de interesse\ndf_une_taq = df_vendas_mensais[df_vendas_mensais['une_nome'].str.upper() == une_interesse.upper()]\n\n# Calcular a variação percentual das vendas\n# Evitar divisão por zero\ndf_une_taq['variacao_percentual'] = 0\n# Calcular a variação apenas se houver vendas nos meses anteriores para evitar divisão por zero\nmask_vendas_anteriores_positivas = df_une_taq['vendas_meses_anteriores'] > 0\ndf_une_taq.loc[mask_vendas_anteriores_positivas, 'variacao_percentual'] = (\n    (df_une_taq['vendas_ultimos_3_meses'] - df_une_taq['vendas_meses_anteriores']) / df_une_taq['vendas_meses_anteriores']\n) * 100\n\n# Identificar segmentos em queda (variação percentual negativa)\nsegmentos_em_queda = df_une_taq[df_une_taq['variacao_percentual'] < 0].sort_values('variacao_percentual', ascending=True)\n\n# Selecionar colunas relevantes para o resultado\nresult = segmentos_em_queda[['nomesegmento', 'vendas_ultimos_3_meses', 'vendas_meses_anteriores', 'variacao_percentual']]\n\n# Adicionar uma coluna para indicar se o segmento está em queda\nresult['status'] = 'Em Queda'\n\n# Se não houver segmentos em queda, retornar um DataFrame vazio com as colunas esperadas\nif result.empty:\n    result = pd.DataFrame(columns=['nomesegmento', 'vendas_ultimos_3_meses', 'vendas_meses_anteriores', 'variacao_percentual', 'status'])", "error_type": "ColumnValidationError", "error_message": "Coluna 'Columns not found: ' não encontrada no DataFrame.\n\nColunas disponíveis:\n", "success": false}
